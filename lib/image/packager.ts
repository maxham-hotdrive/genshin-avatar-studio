import archiver from 'archiver'
import { Readable } from 'stream'
import { PLATFORM_SPECS, WALLPAPER_SPECS } from './processor'

/**
 * åˆ›å»º README å†…å®¹
 */
function createReadmeContent(generationId: string, style: string): string {
  return `
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                  GENSHIN STYLE AVATAR PACK                     â•‘
â•‘                  Generated by Anime Identity Kit                â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Generation ID: ${generationId}
Style: ${style}
Generated: ${new Date().toISOString()}

ğŸ“¦ PACKAGE CONTENTS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

This package contains 18+ optimized avatar images for different platforms:

ğŸ“± SOCIAL MEDIA (01-social-media/)
  â€¢ Discord (128x128) - Perfect for Discord profiles
  â€¢ Twitter/X (400x400) - Optimized for Twitter display
  â€¢ Instagram (320x320) - Instagram profile size
  â€¢ Facebook (180x180) - Facebook profile picture
  â€¢ LinkedIn (400x400) - Professional networking
  â€¢ TikTok (200x200) - TikTok profile image

ğŸ® GAMING PLATFORMS (02-gaming/)
  â€¢ Steam (184x184) - Steam profile avatar
  â€¢ Xbox (1080x1080) - Xbox gamerpic
  â€¢ PlayStation (1000x1000) - PSN profile
  â€¢ Epic Games (512x512) - Epic Games profile
  â€¢ Nintendo (256x256) - Nintendo Switch profile

ğŸ“º STREAMING PLATFORMS (03-streaming/)
  â€¢ Twitch (256x256) - Twitch channel avatar
  â€¢ YouTube (800x800) - YouTube channel icon
  â€¢ Kick (300x300) - Kick streaming profile

ğŸ’¼ PROFESSIONAL USE (04-professional/)
  â€¢ High Resolution (1024x1024) - General high-quality use
  â€¢ Transparent Background (512x512) - For custom backgrounds
  â€¢ Print Quality (2048x2048) - Ultra-high resolution

ğŸ–¼ï¸ BONUS WALLPAPERS (05-wallpapers/)
  â€¢ Mobile Wallpaper (1080x1920) - Phone background
  â€¢ Desktop Wallpaper (1920x1080) - Computer background

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ’¡ USAGE TIPS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. Use platform-specific images for best quality
2. Circular images (Discord, Twitter) already have rounded edges
3. Transparent background version is great for custom edits
4. Print quality version is suitable for merchandise/printing

ğŸ”’ LICENSE
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ“ Personal use: Unlimited
âœ“ Social media profiles: Unlimited
âœ“ Gaming profiles: Unlimited
âœ“ Streaming channels: Unlimited
âœ“ Commercial use: Allowed (with credit)

âœ— Redistribution: Not allowed (don't resell these images)
âœ— AI training: Not allowed

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Need more avatars? Visit: https://anime-identity-kit.com

Questions? Contact: support@anime-identity-kit.com

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Enjoy your new avatar! ğŸ¨âœ¨
`.trim()
}

/**
 * æ–‡ä»¶å¤¹è¯´æ˜æ˜ å°„
 */
const FOLDER_DESCRIPTIONS: Record<string, string> = {
  'social': '01-social-media',
  'gaming': '02-gaming',
  'streaming': '03-streaming',
  'professional': '04-professional'
}

/**
 * åˆ›å»º ZIP åŒ…
 */
export async function createAvatarZip(
  avatarBuffers: Record<string, Buffer>,
  wallpaperBuffers: Record<string, Buffer>,
  metadata: {
    generationId: string
    style: string
  }
): Promise<Buffer> {
  return new Promise((resolve, reject) => {
    const archive = archiver('zip', {
      zlib: { level: 9 } // æœ€é«˜å‹ç¼©çº§åˆ«
    })

    const chunks: Buffer[] = []

    archive.on('data', (chunk: Buffer) => {
      chunks.push(chunk)
    })

    archive.on('end', () => {
      const buffer = Buffer.concat(chunks)
      console.log(`[ZipPackager] âœ“ ZIP created: ${buffer.length} bytes`)
      resolve(buffer)
    })

    archive.on('error', (err) => {
      console.error('[ZipPackager] âœ— ZIP creation failed:', err)
      reject(err)
    })

    console.log('[ZipPackager] Creating ZIP package...')

    // æ·»åŠ  README
    archive.append(createReadmeContent(metadata.generationId, metadata.style), {
      name: 'README.txt'
    })

    // æŒ‰å¹³å°åˆ†ç±»æ·»åŠ å¤´åƒ
    for (const [key, buffer] of Object.entries(avatarBuffers)) {
      const spec = PLATFORM_SPECS[key]
      if (!spec) continue

      const folder = FOLDER_DESCRIPTIONS[spec.category]
      const filename = `${key}-${spec.size}.png`

      archive.append(buffer, {
        name: `${folder}/${filename}`
      })
    }

    // æ·»åŠ å£çº¸
    for (const [key, buffer] of Object.entries(wallpaperBuffers)) {
      const spec = WALLPAPER_SPECS[key]
      if (!spec) continue

      const filename = `${key}-wallpaper-${spec.width}x${spec.height}.png`

      archive.append(buffer, {
        name: `05-wallpapers/${filename}`
      })
    }

    // å®Œæˆæ‰“åŒ…
    archive.finalize()
  })
}

/**
 * ä¸Šä¼  ZIP åˆ° Supabase Storage
 */
export async function uploadZipToSupabase(
  zipBuffer: Buffer,
  generationId: string,
  supabaseClient: any
): Promise<string> {
  const fileName = `${generationId}/avatar-pack.zip`

  console.log(`[ZipPackager] Uploading ZIP to Supabase: ${fileName}`)

  const { data, error } = await supabaseClient.storage
    .from('generated-images')
    .upload(fileName, zipBuffer, {
      contentType: 'application/zip',
      upsert: true
    })

  if (error) {
    console.error('[ZipPackager] Upload failed:', error)
    throw new Error(`Failed to upload ZIP: ${error.message}`)
  }

  // è·å–å…¬å¼€ URL
  const { data: publicData } = supabaseClient.storage
    .from('generated-images')
    .getPublicUrl(fileName)

  console.log(`[ZipPackager] âœ“ ZIP uploaded: ${publicData.publicUrl}`)

  return publicData.publicUrl
}
