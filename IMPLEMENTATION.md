# Genshin Avatar Studio - æŠ€æœ¯å®ç°æ–¹æ¡ˆ

## ğŸ“‹ æ–‡æ¡£ä¿¡æ¯

**é¡¹ç›®åç§°**: Genshin Avatar Studio
**ç‰ˆæœ¬**: v1.0 MVP
**æ¶æ„å¸ˆ**: Technical Team
**æœ€åæ›´æ–°**: 2026-01-12

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ç”¨æˆ·æµè§ˆå™¨                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  é…ç½®ç•Œé¢        â”‚  â”‚  é¢„è§ˆé¡µé¢     â”‚  â”‚  ä¸‹è½½é¡µé¢       â”‚ â”‚
â”‚  â”‚  (React)        â”‚  â”‚  (React)     â”‚  â”‚  (React)       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ HTTPS / WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Vercel Edge Network                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         Next.js 16 App Router (SSR + API Routes)      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚                â”‚
       â”‚                â”‚                â”‚
   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚Replicateâ”‚      â”‚ Supabase â”‚    â”‚  Stripe   â”‚
   â”‚  API    â”‚      â”‚ Database â”‚    â”‚  Payment  â”‚
   â”‚(AIç”Ÿæˆ) â”‚      â”‚ Storage  â”‚    â”‚   API     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                â”‚
       â”‚                â”‚
   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
   â”‚ FLUX.1 â”‚      â”‚ PostgreSQLâ”‚
   â”‚schnell â”‚      â”‚  + S3     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”§ æŠ€æœ¯æ ˆè¯¦è§£

### å‰ç«¯æŠ€æœ¯æ ˆ

**æ¡†æ¶ & åº“**:
```json
{
  "next": "16.1.1",
  "react": "19",
  "typescript": "5",
  "tailwindcss": "4",
  "@radix-ui/react-*": "latest",
  "framer-motion": "^12.25.0",
  "lucide-react": "^0.562.0"
}
```

**å…³é”®ä¾èµ–è¯´æ˜**:
- `Next.js 16.1.1`: ä½¿ç”¨ App Routerï¼Œæ”¯æŒ RSCï¼ˆReact Server Componentsï¼‰
- `TailwindCSS 4`: æ–°ç‰ˆæœ¬ï¼Œæ€§èƒ½æå‡
- `Radix UI`: æ— æ ·å¼ã€å¯è®¿é—®çš„ UI ç»„ä»¶åŸºç¡€åº“
- `Framer Motion`: æµç•…åŠ¨ç”»åº“
- `Lucide React`: ç°ä»£å›¾æ ‡åº“

---

### åç«¯æŠ€æœ¯æ ˆ

**API å±‚**:
```typescript
// Next.js API Routes
app/api/
â”œâ”€â”€ generate-avatar-pack/
â”‚   â””â”€â”€ route.ts          // ä¸»ç”Ÿæˆ API
â”œâ”€â”€ payment/
â”‚   â”œâ”€â”€ create-checkout/  // åˆ›å»ºæ”¯ä»˜
â”‚   â””â”€â”€ webhook/          // Stripe Webhook
â””â”€â”€ status/
    â””â”€â”€ [id]/route.ts     // æŸ¥è¯¢ç”ŸæˆçŠ¶æ€
```

**æ•°æ®åº“ (Supabase PostgreSQL)**:
```sql
-- generations è¡¨
CREATE TABLE generations (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  config JSONB NOT NULL,           -- ç”¨æˆ·é…ç½®
  images JSONB,                     -- ç”Ÿæˆçš„å›¾ç‰‡ URLs
  zip_url TEXT,                     -- ZIP ä¸‹è½½é“¾æ¥
  status TEXT NOT NULL,             -- processing/completed/failed
  created_at TIMESTAMP DEFAULT NOW(),
  completed_at TIMESTAMP,
  paid BOOLEAN DEFAULT FALSE,
  payment_id TEXT,
  error_message TEXT
);

-- users è¡¨ (ç®€åŒ–ç‰ˆ,ç”¨äºè¿½è¸ª)
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  email TEXT UNIQUE,
  created_at TIMESTAMP DEFAULT NOW(),
  generation_count INT DEFAULT 0,
  total_spent DECIMAL DEFAULT 0
);

-- payments è¡¨
CREATE TABLE payments (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES users(id),
  generation_id UUID REFERENCES generations(id),
  stripe_session_id TEXT UNIQUE,
  amount INT NOT NULL,              -- ç¾åˆ†
  status TEXT NOT NULL,             -- pending/completed/failed
  created_at TIMESTAMP DEFAULT NOW(),
  completed_at TIMESTAMP
);
```

**å­˜å‚¨ (Supabase Storage)**:
```
Buckets:
â”œâ”€â”€ generated-images/         (PUBLIC)
â”‚   â”œâ”€â”€ {generationId}/
â”‚   â”‚   â”œâ”€â”€ avatar.png       (åŸå›¾)
â”‚   â”‚   â””â”€â”€ avatar-pack.zip  (ZIP åŒ…)
```

**æ–‡ä»¶å‘½åè§„èŒƒ**:
- åŸå›¾: `{generationId}/avatar.png`
- ZIP åŒ…: `{generationId}/avatar-pack.zip`
- è‡ªåŠ¨åˆ é™¤ç­–ç•¥: 30 å¤©åæ¸…ç†

---

### ç¬¬ä¸‰æ–¹æœåŠ¡

**1. Replicate (AI ç”Ÿæˆ)**
```typescript
// é…ç½®
const REPLICATE_CONFIG = {
  model: 'black-forest-labs/flux-schnell',
  apiToken: process.env.REPLICATE_API_TOKEN,
  timeout: 60000,  // 60ç§’è¶…æ—¶
  retries: 3       // æœ€å¤šé‡è¯•3æ¬¡
}

// è¯·æ±‚å‚æ•°
const input = {
  prompt: generatedPrompt,
  width: 1024,
  height: 1024,
  num_outputs: 1,
  num_inference_steps: 4,
  output_format: 'png'
}
```

**æˆæœ¬è®¡ç®—**:
- FLUX-schnell: ~$0.003/ç§’ Ã— 30ç§’ = $0.10/å›¾
- æœˆé™é¢: è®¾ç½®ä¸º $100ï¼ˆé˜²æ­¢æ»¥ç”¨ï¼‰

**2. Supabase**
```typescript
// é…ç½®
const SUPABASE_CONFIG = {
  url: process.env.NEXT_PUBLIC_SUPABASE_URL,
  anonKey: process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY,
  serviceRoleKey: process.env.SUPABASE_SERVICE_ROLE_KEY  // æœåŠ¡ç«¯
}

// å­˜å‚¨é…ç½®
Storage:
  - Bucket: generated-images (PUBLIC)
  - Max file size: 10MB
  - Allowed types: image/png, application/zip
  - Auto-delete: 30 days
```

**æˆæœ¬è®¡ç®—**:
- æ•°æ®åº“: Pro Plan $25/æœˆï¼ˆåŒ…å« 8GBï¼‰
- å­˜å‚¨: $0.021/GB/æœˆï¼ˆé¢„è®¡ 5GB = $0.11/æœˆï¼‰
- æµé‡: $0.09/GBï¼ˆé¢„è®¡ 100GB = $9/æœˆï¼‰
- **æ€»è®¡**: ~$35/æœˆ

**3. Stripe**
```typescript
// é…ç½®
const STRIPE_CONFIG = {
  publishableKey: process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY,
  secretKey: process.env.STRIPE_SECRET_KEY,
  webhookSecret: process.env.STRIPE_WEBHOOK_SECRET,
  currency: 'usd',
  mode: 'payment'  // å•æ¬¡æ”¯ä»˜
}

// Checkout Session
{
  mode: 'payment',
  line_items: [{
    price_data: {
      currency: 'usd',
      product_data: {
        name: 'Genshin Avatar Pack',
        description: '18+ platform-ready avatars',
        images: [previewImageUrl]
      },
      unit_amount: 1500  // $15.00
    },
    quantity: 1
  }],
  success_url: `${domain}/download?session_id={CHECKOUT_SESSION_ID}`,
  cancel_url: `${domain}/preview?canceled=true`
}
```

**æˆæœ¬**:
- äº¤æ˜“è´¹: 2.9% + $0.30/ç¬”
- $15 æ”¶å…¥ â†’ Stripe æ”¶ $0.74 â†’ å‡€æ”¶ $14.26

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
anime-identity-kit/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ (marketing)/           # è¥é”€é¡µé¢ç»„
â”‚   â”‚   â”œâ”€â”€ page.tsx           # é¦–é¡µ Landing Page
â”‚   â”‚   â”œâ”€â”€ about/             # å…³äºé¡µé¢
â”‚   â”‚   â”œâ”€â”€ pricing/           # å®šä»·é¡µé¢
â”‚   â”‚   â””â”€â”€ examples/          # ç¤ºä¾‹å±•ç¤º
â”‚   â”‚
â”‚   â”œâ”€â”€ create/                # åˆ›å»ºå™¨é¡µé¢
â”‚   â”‚   â””â”€â”€ page.tsx           # è§’è‰²é…ç½®ç•Œé¢
â”‚   â”‚
â”‚   â”œâ”€â”€ preview/               # é¢„è§ˆé¡µé¢
â”‚   â”‚   â””â”€â”€ page.tsx           # ç”Ÿæˆè¿›åº¦ + é¢„è§ˆ
â”‚   â”‚
â”‚   â”œâ”€â”€ download/              # ä¸‹è½½é¡µé¢
â”‚   â”‚   â””â”€â”€ page.tsx           # æ”¯ä»˜åä¸‹è½½
â”‚   â”‚
â”‚   â”œâ”€â”€ api/                   # API è·¯ç”±
â”‚   â”‚   â”œâ”€â”€ generate-avatar-pack/
â”‚   â”‚   â”‚   â””â”€â”€ route.ts       # ä¸»ç”Ÿæˆ API
â”‚   â”‚   â”œâ”€â”€ payment/
â”‚   â”‚   â”‚   â”œâ”€â”€ create-checkout/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ route.ts   # åˆ›å»º Stripe Checkout
â”‚   â”‚   â”‚   â””â”€â”€ webhook/
â”‚   â”‚   â”‚       â””â”€â”€ route.ts   # Stripe Webhook å¤„ç†
â”‚   â”‚   â””â”€â”€ status/
â”‚   â”‚       â””â”€â”€ [id]/
â”‚   â”‚           â””â”€â”€ route.ts   # æŸ¥è¯¢ç”ŸæˆçŠ¶æ€
â”‚   â”‚
â”‚   â”œâ”€â”€ layout.tsx             # æ ¹å¸ƒå±€
â”‚   â””â”€â”€ globals.css            # å…¨å±€æ ·å¼
â”‚
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ ui/                    # shadcn/ui ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ button.tsx
â”‚   â”‚   â”œâ”€â”€ card.tsx
â”‚   â”‚   â”œâ”€â”€ select.tsx
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚
â”‚   â”œâ”€â”€ creator/               # åˆ›å»ºå™¨ç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ ConfigStep.tsx     # é…ç½®æ­¥éª¤
â”‚   â”‚   â”œâ”€â”€ StyleSelector.tsx  # é£æ ¼é€‰æ‹©å™¨
â”‚   â”‚   â”œâ”€â”€ TraitSelector.tsx  # ç‰¹å¾é€‰æ‹©å™¨
â”‚   â”‚   â””â”€â”€ PreviewPanel.tsx   # é¢„è§ˆé¢æ¿
â”‚   â”‚
â”‚   â”œâ”€â”€ generation/            # ç”Ÿæˆç»„ä»¶
â”‚   â”‚   â”œâ”€â”€ ProgressBar.tsx    # è¿›åº¦æ¡
â”‚   â”‚   â”œâ”€â”€ StatusIndicator.tsx # çŠ¶æ€æŒ‡ç¤ºå™¨
â”‚   â”‚   â””â”€â”€ ImageGrid.tsx      # å›¾ç‰‡ç½‘æ ¼
â”‚   â”‚
â”‚   â””â”€â”€ shared/                # å…±äº«ç»„ä»¶
â”‚       â”œâ”€â”€ Header.tsx
â”‚       â”œâ”€â”€ Footer.tsx
â”‚       â””â”€â”€ LoadingSpinner.tsx
â”‚
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ image/
â”‚   â”‚   â”œâ”€â”€ processor.ts       # å›¾ç‰‡å¤„ç†ï¼ˆresize, cropï¼‰
â”‚   â”‚   â””â”€â”€ packager.ts        # ZIP æ‰“åŒ…
â”‚   â”‚
â”‚   â”œâ”€â”€ prompts/
â”‚   â”‚   â””â”€â”€ generator.ts       # Prompt ç”Ÿæˆå™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ replicate/
â”‚   â”‚   â””â”€â”€ client.ts          # Replicate API å®¢æˆ·ç«¯
â”‚   â”‚
â”‚   â”œâ”€â”€ supabase/
â”‚   â”‚   â”œâ”€â”€ client.ts          # æµè§ˆå™¨ç«¯å®¢æˆ·ç«¯
â”‚   â”‚   â””â”€â”€ admin.ts           # æœåŠ¡ç«¯å®¢æˆ·ç«¯
â”‚   â”‚
â”‚   â”œâ”€â”€ stripe/
â”‚   â”‚   â””â”€â”€ client.ts          # Stripe é›†æˆ
â”‚   â”‚
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ validation.ts      # é…ç½®éªŒè¯
â”‚       â””â”€â”€ helpers.ts         # å·¥å…·å‡½æ•°
â”‚
â”œâ”€â”€ types/
â”‚   â””â”€â”€ index.ts               # TypeScript ç±»å‹å®šä¹‰
â”‚
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ images/                # é™æ€å›¾ç‰‡
â”‚   â”œâ”€â”€ examples/              # ç¤ºä¾‹å¤´åƒ
â”‚   â””â”€â”€ favicon.ico
â”‚
â”œâ”€â”€ .env.local                 # ç¯å¢ƒå˜é‡
â”œâ”€â”€ next.config.ts             # Next.js é…ç½®
â”œâ”€â”€ tailwind.config.ts         # TailwindCSS é…ç½®
â”œâ”€â”€ tsconfig.json              # TypeScript é…ç½®
â””â”€â”€ package.json
```

---

## ğŸ”„ æ ¸å¿ƒä¸šåŠ¡æµç¨‹

### 1. å¤´åƒç”Ÿæˆæµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Frontend as å‰ç«¯
    participant API as API Route
    participant Replicate as Replicate API
    participant Sharp as Sharp å›¾ç‰‡å¤„ç†
    participant Supabase as Supabase Storage
    participant DB as PostgreSQL

    User->>Frontend: é…ç½®è§’è‰²å¹¶æäº¤
    Frontend->>API: POST /api/generate-avatar-pack
    API->>DB: åˆ›å»º generation è®°å½•(status: processing)
    API-->>Frontend: è¿”å› generationId
    Frontend->>Frontend: å¼€å§‹è½®è¯¢çŠ¶æ€

    API->>Replicate: è°ƒç”¨ FLUX.1-schnell
    Replicate-->>API: è¿”å› Uint8Array å›¾ç‰‡æ•°æ®
    API->>Sharp: å¤„ç†åŸå›¾ç”Ÿæˆ18+å°ºå¯¸
    Sharp-->>API: è¿”å›å¤„ç†åçš„ Buffer æ•°ç»„
    API->>API: æ‰“åŒ…æˆ ZIP
    API->>Supabase: ä¸Šä¼  ZIP åˆ° Storage
    Supabase-->>API: è¿”å›å…¬å¼€ URL
    API->>DB: æ›´æ–° generation(status: completed, zip_url)

    Frontend->>API: GET /api/status/{id}
    API->>DB: æŸ¥è¯¢ generation çŠ¶æ€
    DB-->>API: è¿”å›çŠ¶æ€å’Œ URLs
    API-->>Frontend: è¿”å›å®ŒæˆçŠ¶æ€
    Frontend->>User: æ˜¾ç¤ºé¢„è§ˆå’Œä¸‹è½½æŒ‰é’®
```

**è¯¦ç»†æ­¥éª¤**:

**Step 1: ç”¨æˆ·é…ç½® (frontend)**
```typescript
// app/create/page.tsx
const handleSubmit = async (config: AvatarConfig) => {
  // éªŒè¯é…ç½®
  const validation = validateConfig(config)
  if (!validation.valid) {
    showError(validation.errors)
    return
  }

  // è°ƒç”¨ç”Ÿæˆ API
  const response = await fetch('/api/generate-avatar-pack', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ config })
  })

  const { generationId } = await response.json()

  // è·³è½¬åˆ°é¢„è§ˆé¡µé¢
  router.push(`/preview?id=${generationId}`)
}
```

**Step 2: æœåŠ¡ç«¯ç”Ÿæˆ (API)**
```typescript
// app/api/generate-avatar-pack/route.ts
export async function POST(request: NextRequest) {
  // 1. è§£æé…ç½®
  const { config } = await request.json()

  // 2. åˆ›å»ºæ•°æ®åº“è®°å½•
  const { data: generation } = await supabaseAdmin
    .from('generations')
    .insert({
      config,
      status: 'processing'
    })
    .select()
    .single()

  // 3. AI ç”ŸæˆåŸå›¾
  const originalImageUrl = await generateImage(
    config,
    'avatar',
    generation.id,
    { width: 1024, height: 1024 }
  )

  // 4. ä¸‹è½½åŸå›¾åˆ° Buffer
  const imageResponse = await fetch(originalImageUrl)
  const originalImageBuffer = Buffer.from(
    await imageResponse.arrayBuffer()
  )

  // 5. ç”Ÿæˆå¤šå¹³å°å°ºå¯¸
  const avatarBuffers = await generateAvatarPack(originalImageBuffer)

  // 6. ç”Ÿæˆå£çº¸
  const wallpaperBuffers = await generateWallpapers(originalImageBuffer)

  // 7. æ‰“åŒ…æˆ ZIP
  const zipBuffer = await createAvatarZip(
    avatarBuffers,
    wallpaperBuffers,
    { generationId: generation.id, style: 'genshin' }
  )

  // 8. ä¸Šä¼  ZIP åˆ° Supabase
  const zipUrl = await uploadZipToSupabase(
    zipBuffer,
    generation.id,
    supabaseAdmin
  )

  // 9. æ›´æ–°æ•°æ®åº“
  await supabaseAdmin
    .from('generations')
    .update({
      images: { original: originalImageUrl, zip: zipUrl },
      status: 'completed',
      completed_at: new Date().toISOString()
    })
    .eq('id', generation.id)

  return NextResponse.json({
    success: true,
    generationId: generation.id,
    zipUrl
  })
}
```

**Step 3: å‰ç«¯è½®è¯¢çŠ¶æ€**
```typescript
// app/preview/page.tsx
useEffect(() => {
  const pollStatus = async () => {
    const response = await fetch(`/api/status/${generationId}`)
    const data = await response.json()

    setStatus(data.status)
    setProgress(calculateProgress(data.status))

    if (data.status === 'completed') {
      setZipUrl(data.images.zip)
      clearInterval(intervalId)
    } else if (data.status === 'failed') {
      setError(data.error)
      clearInterval(intervalId)
    }
  }

  const intervalId = setInterval(pollStatus, 2000)  // æ¯2ç§’è½®è¯¢
  return () => clearInterval(intervalId)
}, [generationId])
```

---

### 2. æ”¯ä»˜æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Frontend as å‰ç«¯
    participant API as API Route
    participant Stripe as Stripe
    participant DB as PostgreSQL

    User->>Frontend: ç‚¹å‡»"è´­ä¹°å¹¶ä¸‹è½½"
    Frontend->>API: POST /api/payment/create-checkout
    API->>DB: åˆ›å»º payment è®°å½•
    API->>Stripe: åˆ›å»º Checkout Session
    Stripe-->>API: è¿”å› Session URL
    API-->>Frontend: è¿”å› URL
    Frontend->>User: é‡å®šå‘åˆ° Stripe Checkout

    User->>Stripe: å®Œæˆæ”¯ä»˜
    Stripe->>API: POST /api/payment/webhook
    API->>API: éªŒè¯ Webhook ç­¾å
    API->>DB: æ›´æ–° payment(status: completed)
    API->>DB: æ›´æ–° generation(paid: true)
    API-->>Stripe: è¿”å› 200 OK

    Stripe->>User: é‡å®šå‘åˆ° success_url
    User->>Frontend: è®¿é—® /download?session_id=xxx
    Frontend->>API: GET /api/status/{id}
    API->>DB: éªŒè¯ paid çŠ¶æ€
    DB-->>API: è¿”å›å·²ä»˜è´¹æ•°æ®
    API-->>Frontend: è¿”å› ZIP URL
    Frontend->>User: æ˜¾ç¤ºä¸‹è½½æŒ‰é’®
```

**è¯¦ç»†å®ç°**:

**Step 1: åˆ›å»º Stripe Checkout**
```typescript
// app/api/payment/create-checkout/route.ts
export async function POST(request: NextRequest) {
  const { generationId } = await request.json()

  // 1. åˆ›å»ºæ”¯ä»˜è®°å½•
  const { data: payment } = await supabaseAdmin
    .from('payments')
    .insert({
      generation_id: generationId,
      amount: 1500,  // $15.00
      status: 'pending'
    })
    .select()
    .single()

  // 2. åˆ›å»º Stripe Checkout Session
  const session = await stripe.checkout.sessions.create({
    mode: 'payment',
    line_items: [{
      price_data: {
        currency: 'usd',
        product_data: {
          name: 'Genshin Avatar Pack',
          description: '18+ platform-ready avatars + wallpapers'
        },
        unit_amount: 1500
      },
      quantity: 1
    }],
    metadata: {
      paymentId: payment.id,
      generationId
    },
    success_url: `${process.env.NEXT_PUBLIC_URL}/download?session_id={CHECKOUT_SESSION_ID}`,
    cancel_url: `${process.env.NEXT_PUBLIC_URL}/preview?id=${generationId}&canceled=true`
  })

  // 3. æ›´æ–°æ”¯ä»˜è®°å½•
  await supabaseAdmin
    .from('payments')
    .update({ stripe_session_id: session.id })
    .eq('id', payment.id)

  return NextResponse.json({ url: session.url })
}
```

**Step 2: Webhook å¤„ç†**
```typescript
// app/api/payment/webhook/route.ts
export async function POST(request: NextRequest) {
  const body = await request.text()
  const signature = request.headers.get('stripe-signature')

  // 1. éªŒè¯ Webhook ç­¾å
  const event = stripe.webhooks.constructEvent(
    body,
    signature,
    process.env.STRIPE_WEBHOOK_SECRET
  )

  // 2. å¤„ç†äº‹ä»¶
  if (event.type === 'checkout.session.completed') {
    const session = event.data.object

    // 3. æ›´æ–°æ”¯ä»˜çŠ¶æ€
    await supabaseAdmin
      .from('payments')
      .update({
        status: 'completed',
        completed_at: new Date().toISOString()
      })
      .eq('stripe_session_id', session.id)

    // 4. æ ‡è®° generation ä¸ºå·²ä»˜è´¹
    await supabaseAdmin
      .from('generations')
      .update({ paid: true })
      .eq('id', session.metadata.generationId)
  }

  return NextResponse.json({ received: true })
}
```

---

## ğŸ–¼ï¸ å›¾ç‰‡å¤„ç†ç®¡é“

### Prompt ç”Ÿæˆç­–ç•¥

**æ ¸å¿ƒ Prompt ç»“æ„**:
```typescript
function generatePrompt(config: AvatarConfig): string {
  const parts: string[] = []

  // 1. é£æ ¼ï¼ˆæœ€é‡è¦ï¼‰
  parts.push('Genshin Impact style')
  parts.push('anime cel-shaded, vibrant colors')
  parts.push('miHoYo official art style')

  // 2. ä¸€è‡´æ€§æ ‡ç­¾
  parts.push('same character, consistent character design')
  parts.push('character reference sheet style')

  // 3. è¡¨æƒ…
  parts.push('neutral expression, calm and confident')
  parts.push('front-facing portrait')

  // 4. æ€§åˆ«
  parts.push(config.gender === 'male'
    ? 'male character, masculine features'
    : 'female character, feminine features')

  // 5. å‘å‹ + å‘è‰²
  parts.push(`${config.hairColor} hair`)
  parts.push(`${config.hairStyle} hairstyle`)

  // 6. çœ¼ç›é¢œè‰²
  parts.push(`${config.eyeColor} eyes, expressive eyes`)

  // 7. ç‰¹æ®Šç‰¹å¾
  if (config.traits.length > 0) {
    parts.push(config.traits.map(t => TRAIT_PROMPTS[t]).join(', '))
  }

  // 8. æ„å›¾
  parts.push('bust shot, from chest up')
  parts.push('centered composition, white background')
  parts.push('front view, looking at viewer')

  // 9. è´¨é‡è¯
  parts.push('masterpiece, best quality, highly detailed, sharp focus')
  parts.push('consistent lighting, professional character design')

  return parts.join(', ')
}
```

**ç¤ºä¾‹è¾“å‡º**:
```
"Genshin Impact style, anime cel-shaded, vibrant colors, miHoYo official art style, same character, consistent character design, character reference sheet style, neutral expression, calm and confident, front-facing portrait, female character, feminine features, blonde hair, twin tails hairstyle, blue eyes, expressive eyes, cat ears, neko features, bust shot, from chest up, centered composition, white background, front view, looking at viewer, masterpiece, best quality, highly detailed, sharp focus, consistent lighting, professional character design"
```

---

### Sharp å›¾ç‰‡å¤„ç†

**åœ†å½¢è£å‰ªå®ç°**:
```typescript
// lib/image/processor.ts
async function createCircleMask(size: number): Promise<Buffer> {
  const svg = `
    <svg width="${size}" height="${size}">
      <circle cx="${size/2}" cy="${size/2}" r="${size/2}" fill="white"/>
    </svg>
  `
  return Buffer.from(svg)
}

async function processAvatar(
  inputBuffer: Buffer,
  platform: PlatformSpec
): Promise<Buffer> {
  let image = sharp(inputBuffer)

  // 1. Resize åˆ°ç›®æ ‡å°ºå¯¸
  image = image.resize(platform.size, platform.size, {
    fit: 'cover',
    position: 'center'
  })

  // 2. åœ†å½¢è£å‰ª
  if (platform.shape === 'circle') {
    const mask = await createCircleMask(platform.size)
    image = image.composite([{
      input: mask,
      blend: 'dest-in'
    }])
  }

  // 3. è¾“å‡º PNG
  return image.png({ quality: 95 }).toBuffer()
}
```

**æ‰¹é‡å¤„ç†**:
```typescript
async function generateAvatarPack(
  originalImageBuffer: Buffer
): Promise<Record<string, Buffer>> {
  const results: Record<string, Buffer> = {}

  // å¹¶è¡Œå¤„ç†æ‰€æœ‰å¹³å°å°ºå¯¸
  const promises = Object.entries(PLATFORM_SPECS).map(async ([key, spec]) => {
    const buffer = await processAvatar(originalImageBuffer, spec)
    results[key] = buffer
  })

  await Promise.all(promises)

  return results
}
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜ç­–ç•¥

**Vercel Edge ç¼“å­˜**:
```typescript
// next.config.ts
const nextConfig = {
  headers: async () => [
    {
      source: '/api/status/:path*',
      headers: [
        {
          key: 'Cache-Control',
          value: 'public, s-maxage=10, stale-while-revalidate=30'
        }
      ]
    }
  ]
}
```

**å‰ç«¯ç¼“å­˜**:
```typescript
// SWR é…ç½®
import useSWR from 'swr'

const { data, error } = useSWR(
  `/api/status/${generationId}`,
  fetcher,
  {
    refreshInterval: 2000,  // æ¯2ç§’åˆ·æ–°
    revalidateOnFocus: false
  }
)
```

---

### 2. å›¾ç‰‡ä¼˜åŒ–

**Next.js Image ç»„ä»¶**:
```typescript
<Image
  src={zipUrl}
  alt="Generated Avatar"
  width={512}
  height={512}
  priority
  placeholder="blur"
  blurDataURL={lowResBlur}
/>
```

**æ‡’åŠ è½½**:
```typescript
// ç¼©ç•¥å›¾ç½‘æ ¼æ‡’åŠ è½½
const ImageGrid = () => {
  return (
    <div className="grid grid-cols-4 gap-4">
      {images.map((img, i) => (
        <Image
          key={i}
          src={img}
          loading="lazy"  // æ‡’åŠ è½½
          width={200}
          height={200}
        />
      ))}
    </div>
  )
}
```

---

### 3. API ä¼˜åŒ–

**å¹¶è¡Œå¤„ç†**:
```typescript
// å¹¶è¡Œç”Ÿæˆå¤šä¸ªå°ºå¯¸
const [avatarBuffers, wallpaperBuffers] = await Promise.all([
  generateAvatarPack(originalImageBuffer),
  generateWallpapers(originalImageBuffer)
])
```

**æµå¼å¤„ç†**:
```typescript
// Replicate è¿”å›çš„æµå¼æ•°æ®
for await (const chunk of output as AsyncIterable<any>) {
  if (chunk instanceof Uint8Array) {
    chunks.push(chunk)
  }
}
```

---

## ğŸ”’ å®‰å…¨æªæ–½

### 1. API é™æµ

**Vercel Edge Config**:
```typescript
// middleware.ts
import { Ratelimit } from '@upstash/ratelimit'
import { Redis } from '@upstash/redis'

const ratelimit = new Ratelimit({
  redis: Redis.fromEnv(),
  limiter: Ratelimit.slidingWindow(10, '1 h'),  // 10æ¬¡/å°æ—¶
  analytics: true
})

export async function middleware(request: NextRequest) {
  const ip = request.ip ?? '127.0.0.1'
  const { success } = await ratelimit.limit(ip)

  if (!success) {
    return NextResponse.json(
      { error: 'Too many requests' },
      { status: 429 }
    )
  }

  return NextResponse.next()
}
```

---

### 2. è¾“å…¥éªŒè¯

**Zod éªŒè¯**:
```typescript
import { z } from 'zod'

const ConfigSchema = z.object({
  gender: z.enum(['male', 'female']),
  hairStyle: z.enum(['long', 'short', 'ponytail', 'twintails', 'braid']),
  hairColor: z.enum(['black', 'brown', 'blonde', 'silver', 'white', 'red', 'pink', 'blue', 'purple', 'green']),
  eyeColor: z.enum(['blue', 'green', 'brown', 'red', 'purple', 'gold', 'pink']),
  traits: z.array(z.enum(['glasses', 'eyepatch', 'elf-ears', 'horns', 'wings', 'cat-ears']))
})

// ä½¿ç”¨
const config = ConfigSchema.parse(requestBody)
```

---

### 3. ç¯å¢ƒå˜é‡ä¿æŠ¤

**.env.local**:
```bash
# Replicate
REPLICATE_API_TOKEN=r8_xxx...

# Supabase
NEXT_PUBLIC_SUPABASE_URL=https://xxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJxxx...
SUPABASE_SERVICE_ROLE_KEY=eyJxxx...  # ä»…æœåŠ¡ç«¯

# Stripe
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_xxx...
STRIPE_SECRET_KEY=sk_test_xxx...     # ä»…æœåŠ¡ç«¯
STRIPE_WEBHOOK_SECRET=whsec_xxx...   # ä»…æœåŠ¡ç«¯

# App
NEXT_PUBLIC_URL=https://genshin-avatar.studio
```

**éªŒè¯**:
```typescript
// lib/utils/env.ts
const requiredEnvVars = [
  'REPLICATE_API_TOKEN',
  'NEXT_PUBLIC_SUPABASE_URL',
  'SUPABASE_SERVICE_ROLE_KEY',
  'STRIPE_SECRET_KEY'
]

requiredEnvVars.forEach(key => {
  if (!process.env[key]) {
    throw new Error(`Missing required env var: ${key}`)
  }
})
```

---

## ğŸ“Š ç›‘æ§ä¸æ—¥å¿—

### 1. æ—¥å¿—ç­–ç•¥

**ç»“æ„åŒ–æ—¥å¿—**:
```typescript
// lib/utils/logger.ts
export const logger = {
  info: (message: string, meta?: any) => {
    console.log(JSON.stringify({
      level: 'info',
      message,
      ...meta,
      timestamp: new Date().toISOString()
    }))
  },

  error: (message: string, error: any, meta?: any) => {
    console.error(JSON.stringify({
      level: 'error',
      message,
      error: error.message,
      stack: error.stack,
      ...meta,
      timestamp: new Date().toISOString()
    }))
  }
}

// ä½¿ç”¨
logger.info('Image generated', {
  generationId,
  duration: Date.now() - startTime
})
```

---

### 2. é”™è¯¯è¿½è¸ª

**Sentry é›†æˆ**ï¼ˆå¯é€‰ï¼‰:
```typescript
// sentry.client.config.ts
import * as Sentry from '@sentry/nextjs'

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  tracesSampleRate: 0.1,
  environment: process.env.NODE_ENV
})
```

---

## ğŸš€ éƒ¨ç½²æµç¨‹

### 1. Vercel éƒ¨ç½²

**vercel.json**:
```json
{
  "buildCommand": "npm run build",
  "devCommand": "npm run dev",
  "installCommand": "npm install",
  "framework": "nextjs",
  "regions": ["iad1"],
  "env": {
    "NEXT_PUBLIC_URL": "https://genshin-avatar.studio"
  }
}
```

**éƒ¨ç½²æ­¥éª¤**:
```bash
# 1. è¿æ¥ Vercel
vercel link

# 2. è®¾ç½®ç¯å¢ƒå˜é‡
vercel env add REPLICATE_API_TOKEN
vercel env add SUPABASE_SERVICE_ROLE_KEY
vercel env add STRIPE_SECRET_KEY
vercel env add STRIPE_WEBHOOK_SECRET

# 3. éƒ¨ç½²
vercel --prod
```

---

### 2. Supabase è®¾ç½®

**åˆå§‹åŒ–æ•°æ®åº“**:
```bash
# 1. åˆ›å»ºè¡¨
supabase db push

# 2. åˆ›å»º Storage Bucket
supabase storage create generated-images --public

# 3. è®¾ç½® RLS ç­–ç•¥
supabase db push --include-roles
```

---

### 3. Stripe Webhook è®¾ç½®

**æ­¥éª¤**:
1. ç™»å½• Stripe Dashboard
2. è¿›å…¥ Developers â†’ Webhooks
3. æ·»åŠ  endpoint: `https://genshin-avatar.studio/api/payment/webhook`
4. é€‰æ‹©äº‹ä»¶: `checkout.session.completed`
5. å¤åˆ¶ Webhook Secret åˆ°ç¯å¢ƒå˜é‡

---

## âœ… æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•

```typescript
// __tests__/lib/prompts/generator.test.ts
import { generatePrompt } from '@/lib/prompts/generator'

describe('Prompt Generator', () => {
  it('should generate valid Genshin prompt', () => {
    const config = {
      gender: 'female',
      hairStyle: 'twintails',
      hairColor: 'blonde',
      eyeColor: 'blue',
      traits: ['cat-ears']
    }

    const prompt = generatePrompt(config, 'avatar')

    expect(prompt).toContain('Genshin Impact style')
    expect(prompt).toContain('blonde hair')
    expect(prompt).toContain('cat ears')
  })
})
```

---

### 2. é›†æˆæµ‹è¯•

```typescript
// __tests__/api/generate.test.ts
import { POST } from '@/app/api/generate-avatar-pack/route'

describe('Generate Avatar Pack API', () => {
  it('should create generation record', async () => {
    const request = new Request('http://localhost:3000/api/generate-avatar-pack', {
      method: 'POST',
      body: JSON.stringify({ config: validConfig })
    })

    const response = await POST(request)
    const data = await response.json()

    expect(response.status).toBe(200)
    expect(data.generationId).toBeDefined()
  })
})
```

---

### 3. E2E æµ‹è¯•

**Playwright é…ç½®**:
```typescript
// e2e/avatar-generation.spec.ts
import { test, expect } from '@playwright/test'

test('complete avatar generation flow', async ({ page }) => {
  // 1. è®¿é—®åˆ›å»ºé¡µé¢
  await page.goto('http://localhost:3000/create')

  // 2. é…ç½®è§’è‰²
  await page.selectOption('[name="gender"]', 'female')
  await page.selectOption('[name="hairStyle"]', 'twintails')
  await page.selectOption('[name="hairColor"]', 'blonde')

  // 3. æäº¤
  await page.click('button[type="submit"]')

  // 4. ç­‰å¾…é¢„è§ˆé¡µé¢
  await page.waitForURL(/\/preview/)

  // 5. éªŒè¯ç”Ÿæˆå®Œæˆ
  await expect(page.locator('.download-button')).toBeVisible({
    timeout: 120000  // 2åˆ†é’Ÿè¶…æ—¶
  })
})
```

---

## ğŸ“ å¼€å‘å·¥ä½œæµ

### æœ¬åœ°å¼€å‘

```bash
# 1. å…‹éš†é¡¹ç›®
git clone https://github.com/yourname/genshin-avatar-studio.git
cd genshin-avatar-studio

# 2. å®‰è£…ä¾èµ–
npm install

# 3. è®¾ç½®ç¯å¢ƒå˜é‡
cp .env.example .env.local
# ç¼–è¾‘ .env.local å¡«å…¥çœŸå® API keys

# 4. åˆå§‹åŒ–æ•°æ®åº“
npm run db:push

# 5. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev
```

---

### Git å·¥ä½œæµ

**åˆ†æ”¯ç­–ç•¥**:
```
main            # ç”Ÿäº§ç¯å¢ƒ
â”œâ”€â”€ develop     # å¼€å‘ç¯å¢ƒ
â”‚   â”œâ”€â”€ feature/avatar-generation
â”‚   â”œâ”€â”€ feature/payment-integration
â”‚   â””â”€â”€ fix/image-quality
```

**æäº¤è§„èŒƒ**:
```bash
feat: æ·»åŠ åœ†å½¢å¤´åƒè£å‰ªåŠŸèƒ½
fix: ä¿®å¤ ZIP ä¸‹è½½å¤±è´¥é—®é¢˜
docs: æ›´æ–° API æ–‡æ¡£
perf: ä¼˜åŒ–å›¾ç‰‡å¤„ç†æ€§èƒ½
test: æ·»åŠ  Prompt ç”Ÿæˆå™¨æµ‹è¯•
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³å¼€å§‹ï¼ˆä»Šå¤©ï¼‰

- [ ] åˆ›å»º Vercel é¡¹ç›®
- [ ] è®¾ç½® Supabase é¡¹ç›®
- [ ] è·å– Replicate API Token
- [ ] æ³¨å†Œ Stripe è´¦å·

### Week 1

- [ ] ä¼˜åŒ– Genshin Prompt
- [ ] å®ç°å›¾ç‰‡å¤„ç†ç®¡é“
- [ ] å®Œæˆå‰ç«¯é…ç½®ç•Œé¢
- [ ] é›†æˆæ”¯ä»˜åŠŸèƒ½

### Week 2

- [ ] å†…éƒ¨æµ‹è¯•ï¼ˆ10æ¬¡ç”Ÿæˆï¼‰
- [ ] ä¿®å¤ Bug
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] å‡†å¤‡ Beta å‘å¸ƒ

---

**æ–‡æ¡£ç»“æŸ**

å¦‚éœ€æŠ€æœ¯æ”¯æŒæˆ–æ¾„æ¸…ï¼Œè¯·è”ç³»æŠ€æœ¯å›¢é˜Ÿã€‚
